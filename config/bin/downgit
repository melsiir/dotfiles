#!/usr/bin/env bash

#thanks for
#https://github.com/HSwift/downgit
set -u

# ================= CONFIG =================
JOBS=8
GITHUB_TOKEN="${GITHUB_TOKEN:-}"
# =========================================

if [[ $# -eq 0 ]]; then
  echo "Usage: $0 https://github.com/user/repo[/tree/branch/path]"
  exit 1
fi

URL="$1"
repoExp='^https://github.com/([^/]+)/([^/]+)(/(tree|blob)/([^/]+)(/(.*))?)?$'

[[ ! $URL =~ $repoExp ]] && {
  echo "Invalid GitHub URL"
  exit 1
}

AUTHOR="${BASH_REMATCH[1]}"
PROJECT="${BASH_REMATCH[2]}"
BRANCH="${BASH_REMATCH[5]:-main}"
PATH_IN_REPO="${BASH_REMATCH[7]:-}"

[[ -z "$PATH_IN_REPO" ]] && PATH_IN_REPO=""

AUTH_HEADER=()
[[ -n "$GITHUB_TOKEN" ]] && AUTH_HEADER=(-H "Authorization: token $GITHUB_TOKEN")

warned_rate_limit=0

# -------- API helper --------
api_get() {
  local url="$1"
  local resp status body

  resp=$(curl -sS -w "%{http_code}" "${AUTH_HEADER[@]}" "$url")
  status="${resp: -3}"
  body="${resp::-3}"

  if [[ "$status" == "403" && -z "$GITHUB_TOKEN" && $warned_rate_limit -eq 0 ]]; then
    warned_rate_limit=1
    echo >&2
    echo "⚠️ GitHub API rate limit reached. Consider setting GITHUB_TOKEN to avoid this."
    echo
  fi

  if [[ "$status" != "200" ]]; then
    echo >&2 "GitHub API error $status"
    return 1
  fi

  echo "$body"
}

# -------- Fast scan using Git Trees API --------
scan_tree_fast() {
  api_get "https://api.github.com/repos/$AUTHOR/$PROJECT/git/trees/$BRANCH?recursive=1" |
    jq -r --arg p "$PATH_IN_REPO" '
        .tree[]
        | select(.type=="blob")
        | select(.path | startswith($p))
        | .path
    '
}

# -------- Scan repository --------
echo "Scanning repository..."
mapfile -t FILES < <(scan_tree_fast)

TOTAL="${#FILES[@]}"
if ((TOTAL == 0)); then
  echo "No files found."
  exit 0
fi

echo "Found $TOTAL files. Preparing download..."
echo

# -------- Generate aria2 input --------
ARIA_INPUT="$(mktemp)"
for path in "${FILES[@]}"; do
  RAW_URL="https://raw.githubusercontent.com/$AUTHOR/$PROJECT/$BRANCH/$path"
  echo "$RAW_URL" >>"$ARIA_INPUT"
  echo "  out=$path" >>"$ARIA_INPUT"
done

# Ensure root directories exist
for path in "${FILES[@]}"; do
  mkdir -p "$(dirname "$path")"
done

# -------- Download with aria2 --------
aria2c --file-allocation=none \
  -i "$ARIA_INPUT" \
  -j "$JOBS" \
  -x 1 -s 1 \
  --continue=false \
  --summary-interval=1

rm -f "$ARIA_INPUT"

echo
echo "Download completed ✔"
