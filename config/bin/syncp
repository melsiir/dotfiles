#!/data/data/com.termux/files/usr/bin/bash
set -e

BASE_DIR="$HOME/.sync_project"
PROJECTS_DIR="$BASE_DIR/projects"
LOG_FILE="$BASE_DIR/sync.log"

ANDROID_IDE_ROOT="$HOME/storage/shared/AndroidIDEProjects"

mkdir -p "$PROJECTS_DIR"

get_termux_dir() {
  echo "$PWD"
}

pick_ide_project() {
  ls -1 "$ANDROID_IDE_ROOT" 2>/dev/null |
    fzf --prompt="AndroidIDE project: " |
    sed "s|^|$ANDROID_IDE_ROOT/|"
}

detect_project_from_pwd() {
  local match=""
  local count=0

  for conf in "$PROJECTS_DIR"/*.conf; do
    [[ -f "$conf" ]] || continue
    source "$conf"

    if [[ "$PWD" == "$TERMUX_DIR" ]]; then
      match=$(basename "$conf" .conf)
      count=$((count + 1))
    fi
  done

  if [[ "$count" -eq 1 ]]; then
    echo "$match"
  fi
}

select_project() {
  local projects
  projects=$(ls "$PROJECTS_DIR" 2>/dev/null | sed 's/\.conf$//')

  printf "%s\n[NEW PROJECT]" "$projects" | fzf --prompt="Select project: "
}

create_project() {
  read -rp "Enter project name: " PROJECT_NAME

  echo "Using current directory as TERMUX project:"
  TERMUX_DIR=$(get_termux_dir)

  if [[ "$TERMUX_DIR" == "$HOME" ]]; then
    echo "❌ Refusing to sync HOME directory"
    exit 1
  fi

  echo "Select AndroidIDE project directory"
  IDE_DIR=$(pick_ide_project)
  CONFIG_FILE="$PROJECTS_DIR/$PROJECT_NAME.conf"

  cat >"$CONFIG_FILE" <<EOF
TERMUX_DIR="$TERMUX_DIR"
IDE_DIR="$IDE_DIR"
EOF

  echo "✔ Project '$PROJECT_NAME' created"
}

load_project() {
  CONFIG_FILE="$PROJECTS_DIR/$PROJECT_NAME.conf"

  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "❌ Project config not found"
    exit 1
  fi

  source "$CONFIG_FILE"

  if [[ ! -d "$TERMUX_DIR" || ! -d "$IDE_DIR" ]]; then
    echo "❌ One or more project directories no longer exist"
    exit 1
  fi
}

sync_dirs() {
  echo "===== [$PROJECT_NAME] Sync started: $(date) =====" >>"$LOG_FILE"

  rsync -avu --delete \
    --exclude='.git/' \
    --exclude='build/' \
    --exclude='.gradle/' \
    "$TERMUX_DIR/" "$IDE_DIR/" >>"$LOG_FILE" 2>&1

  rsync -avu --delete \
    --exclude='.git/' \
    --exclude='build/' \
    --exclude='.gradle/' \
    "$IDE_DIR/" "$TERMUX_DIR/" >>"$LOG_FILE" 2>&1

  echo "===== [$PROJECT_NAME] Sync finished: $(date) =====" >>"$LOG_FILE"
  echo "" >>"$LOG_FILE"
}

PROJECT_NAME=$(detect_project_from_pwd)

if [[ -z "$PROJECT_NAME" ]]; then
  PROJECT_NAME=$(select_project)
fi

if [[ "$PROJECT_NAME" == "[NEW PROJECT]" || -z "$PROJECT_NAME" ]]; then
  create_project
else
  load_project
fi

sync_dirs

echo "✔ Sync complete for project: $PROJECT_NAME"
echo "Termux : $TERMUX_DIR"
echo "IDE    : $IDE_DIR"
