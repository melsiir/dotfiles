#!/usr/bin/env fish

if test (count $argv) -ne 1
    echo "Usage: mtcr_to_patch.fish file.mtcr"
    exit 1
end

set MTCR $argv[1]

if not test -f "$MTCR"
    echo "File not found: $MTCR"
    exit 1
end

set WORKDIR (mktemp -d)

# unzip quietly
unzip -q "$MTCR" -d "$WORKDIR"

set A "$WORKDIR/a"
set B "$WORKDIR/b"

set PATCH_OUT "output.patch"
echo -n "" >"$PATCH_OUT"

if not test -d "$A"
    echo "Folder A not found in mtcr"
    exit 1
end

# find all files in A
for file in (find "$A" -type f)
    set relative (string replace -r "^$A/" "" "$file")
    set fileA "$A/$relative"
    set fileB "$B/$relative"

    if test -f "$fileB"
        echo "--- a/$relative" >>"$PATCH_OUT"
        echo "+++ b/$relative" >>"$PATCH_OUT"
        diff -u "$fileA" "$fileB" >>"$PATCH_OUT"
    end
end

echo "Done. Patch saved as: $PATCH_OUT"

rm -rf "$WORKDIR"
